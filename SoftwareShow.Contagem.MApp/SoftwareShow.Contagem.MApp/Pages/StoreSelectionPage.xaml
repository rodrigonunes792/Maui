<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="SoftwareShow.Contagem.MApp.Pages.StoreSelectionPage"
             xmlns:controls="clr-namespace:SoftwareShow.Contagem.MApp.Controls"
             BackgroundColor="{StaticResource BackgroundColor}"
             Shell.NavBarIsVisible="False"
             Title="SeleÃ§Ã£o de Lojas">

    <Grid RowDefinitions="Auto,Auto,Auto,Auto,*,Auto">

        <!-- Header PadrÃ£o -->
        <controls:StandardHeader Grid.Row="0"
                               Title="SeleÃ§Ã£o de Lojas"
                               ShowBackButton="True"
                               BackClicked="OnBackClicked" />

        <!-- SeÃ§Ã£o SincronizaÃ§Ã£o -->
        <StackLayout Grid.Row="1"
                   BackgroundColor="{StaticResource WhiteColor}" 
                   Padding="0,15,0,20">

            <Label Text="Ative ou desative atualizaÃ§Ã£o de tabelas"
                   Style="{StaticResource SectionTitleStyle}"
                   Margin="20,5,20,10" />

            <!-- Switch Sincronizar -->
            <Grid Margin="20,0" ColumnDefinitions="*,Auto">
                <Label Grid.Column="0"
                       Text="Sincronizar dados"
                       FontSize="16"
                       TextColor="{StaticResource TextColor}"
                       VerticalOptions="Center" />

                <Switch Grid.Column="1"
                        x:Name="SyncSwitch"
                        IsToggled="{Binding IsSyncEnabled}"
                        OnColor="{StaticResource OnColor}"
                        IsEnabled="True"
                        ThumbColor="{StaticResource WhiteColor}" />
            </Grid>
        </StackLayout>

        <!-- Linha divisÃ³ria -->
        <BoxView Grid.Row="2"
                Style="{StaticResource SeparatorLineStyle}" 
                Margin="0" />

        <!-- SeÃ§Ã£o Busca FIXA -->
        <StackLayout Grid.Row="3" 
                   BackgroundColor="{StaticResource BackgroundColor}" 
                   Padding="20,15"
                   Spacing="10">

            <Label Text="Selecione uma loja para continuar"
                   Style="{StaticResource SectionTitleStyle}" />

            <!-- Campo de Pesquisa -->
            <Border Style="{StaticResource EntryBorderStyle}" Margin="0">
                <Grid ColumnDefinitions="*,Auto">
                    <Entry x:Name="SearchEntry"
                           Grid.Column="0"
                           Style="{StaticResource SearchEntryStyle}"
                           Placeholder="Pesquisar a loja"
                           Text="{Binding SearchDisplayText}"
                           TextChanged="OnSearchTextChanged" />

                    <!-- Ãcone Search (quando pesquisando) -->
                    <ImageButton x:Name="SearchIcon"
                               Grid.Column="1"
                               Source="search"
                               HeightRequest="24"
                               WidthRequest="24"
                               BackgroundColor="Transparent"
                               IsVisible="{Binding ShowSearchIcon}"   
                               />

                    <!-- Ãcone X (quando selecionado/preenchido) -->
                    <ImageButton x:Name="ClearIcon"
                               Grid.Column="1"
                               Source="x"
                               HeightRequest="20"
                               WidthRequest="20"
                               BackgroundColor="Transparent"
                               IsVisible="{Binding ShowClearIcon}"
                               Clicked="OnClearButtonClicked" />
                </Grid>
            </Border>

        </StackLayout>

        <!-- Lista de Lojas -->
        <CollectionView Grid.Row="4"
              x:Name="StoresCollectionView"
              ItemsSource="{Binding FilteredStores}"
              BackgroundColor="Transparent"
              Margin="20,0,20,20">

            <CollectionView.ItemTemplate>
                <DataTemplate>
                    <Grid Padding="0,4">
                        <Border BackgroundColor="{StaticResource WhiteColor}"
                        Stroke="#E0E0E0"
                        StrokeThickness="1"
                        StrokeShape="RoundRectangle 8"
                        Padding="15,12">

                            <!-- Adicionar TapGestureRecognizer diretamente no Border -->
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Tapped="OnStoreItemTapped" />
                            </Border.GestureRecognizers>

                            <!-- InformaÃ§Ãµes da loja -->
                            <Label FontSize="16"
                           TextColor="{StaticResource TextColor}"
                           VerticalOptions="Center">
                                <Label.FormattedText>
                                    <FormattedString>
                                        <Span Text="{Binding COD_LOJA, StringFormat='{0:D4}'}" />
                                        <Span Text=" - " />
                                        <Span Text="{Binding NOME_LOJA}" />
                                    </FormattedString>
                                </Label.FormattedText>
                            </Label>

                        </Border>
                    </Grid>
                </DataTemplate>
            </CollectionView.ItemTemplate>

            <!-- Empty View - sÃ³ mostra se nÃ£o hÃ¡ lojas E nÃ£o hÃ¡ loja selecionada -->
            <CollectionView.EmptyView>
                <StackLayout Padding="20" Spacing="10" IsVisible="{Binding ShowEmptyView}">
                    <Label Text="ðŸ“­"
                           FontSize="48"
                           HorizontalOptions="Center"
                           Opacity="0.5" />
                    <Label Text="Nenhuma loja encontrada"
                           FontSize="16"
                           TextColor="#757575"
                           HorizontalOptions="Center" />
                    <Label Text="Tente ajustar sua pesquisa"
                           FontSize="14"
                           TextColor="#757575"
                           HorizontalOptions="Center" />
                </StackLayout>
            </CollectionView.EmptyView>

        </CollectionView>

            <Label x:Name="LabelStatus" 
                   Grid.Row="5"
                   Text="{Binding SyncStatusText}" 
                   TextColor="Black" 
                   VerticalOptions="End" 
                   HorizontalOptions="Center" 
                   Margin="15,0,10,15" />

         <!-- Adicionar o Loading Overlay que vocÃªs jÃ¡ usam -->
           <Grid BackgroundColor="Black"
                  Opacity="0.4"
                  IsVisible="{Binding IsLoading}"
                  VerticalOptions="Fill"
                  HorizontalOptions="Fill"
                  Grid.RowSpan="6">
                <ActivityIndicator IsRunning="{Binding IsLoading}"
                          Color="White"
                          VerticalOptions="Center"
                          HorizontalOptions="Center" />
            </Grid>

        <!-- BotÃ£o Flutuante - Border com ImageButton -->
        <Border x:Name="ContinueFloatingButton"
                    StrokeShape="RoundRectangle 30"
                    BackgroundColor="Black"
                    Stroke="Transparent"
                    IsVisible="{Binding ShowContinueButton}"
                    WidthRequest="60"
                    HeightRequest="60"
                    VerticalOptions="End"
                    HorizontalOptions="End"
                    Margin="0,0,20,30"
                    Grid.Row="5">

            <Border.GestureRecognizers>
                <TapGestureRecognizer Command="{Binding ContinueCommand}" />
            </Border.GestureRecognizers>

            <Image Source="arrow_right_white"
                   BackgroundColor="Transparent"
                   WidthRequest="30"
                   HeightRequest="30" />
        </Border>
    </Grid>
</ContentPage>